<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç®€æ˜“æ„¤æ€’å°é¸Ÿ - æŒ‘æˆ˜ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; }
        h1 { margin: 0; font-size: 20px; text-shadow: 2px 2px 0 #000; }
        p { margin: 5px 0; text-shadow: 1px 1px 0 #000; }
        #resetBtn {
            position: absolute; top: 10px; right: 10px;
            padding: 10px 20px; background: #ff4444; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            box-shadow: 2px 2px 0 #8b0000;
        }
        #resetBtn:active { transform: translateY(2px); box-shadow: none; }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>ğŸ˜¡ ç®€æ˜“æ„¤æ€’å°é¸Ÿ</h1>
        <p>æ‹–æ‹½çº¢è‰²å°é¸Ÿå‘å°„ï¼å‡»å€’ç»¿è‰²æ–¹å—ã€‚</p>
        <p>å½“å‰åˆ†æ•°: <span id="score">0</span></p>
    </div>
    <button id="resetBtn" onclick="initGame()">é‡ç½®å…³å¡</button>

    <script>
        // 1. åˆå§‹åŒ–ç‰©ç†å¼•æ“
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Mouse = Matter.Mouse,
              MouseConstraint = Matter.MouseConstraint,
              Constraint = Matter.Constraint;

        let engine, render, runner, bird, sling;
        let score = 0;
        let isFired = false;

        function initGame() {
            // æ¸…ç†æ—§æ¸¸æˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (render) {
                Render.stop(render);
                Runner.stop(runner);
                if (render.canvas) render.canvas.remove();
            }

            // é‡ç½®çŠ¶æ€
            score = 0;
            isFired = false;
            updateScore(0);

            // åˆ›å»ºå¼•æ“
            engine = Engine.create();
            const world = engine.world;

            // åˆ›å»ºæ¸²æŸ“å™¨
            render = Render.create({
                element: document.body,
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    wireframes: false,
                    background: '#87CEEB'
                }
            });

            // 2. åˆ›å»ºç‰©ä½“
            const width = window.innerWidth;
            const height = window.innerHeight;

            // åœ°é¢
            const ground = Bodies.rectangle(width / 2, height - 20, width, 40, { 
                isStatic: true, 
                render: { fillStyle: '#654321' } 
            });

            // å¹³å°
            const platform = Bodies.rectangle(width - 200, height - 100, 300, 20, { 
                isStatic: true, 
                render: { fillStyle: '#8B4513' } 
            });

            // å°é¸Ÿ
            bird = Bodies.circle(200, height - 150, 20, { 
                density: 0.004,
                restitution: 0.5,
                render: { fillStyle: '#ff0000' }
            });

            // å¼¹å¼“é”šç‚¹
            const anchor = { x: 200, y: height - 150 };
            
            // å¼¹å¼“çš®ç­‹
            sling = Constraint.create({
                pointA: anchor,
                bodyB: bird,
                stiffness: 0.05,
                damping: 0.01,
                length: 1,
                render: { visible: true, strokeStyle: '#333', lineWidth: 3 }
            });

            // æ•Œäººï¼ˆç»¿çŒª/æ–¹å—ï¼‰- å †å èµ·æ¥
            const boxOptions = { render: { fillStyle: '#32CD32' } }; // ç»¿è‰²
            const pyramid = Composite.create();
            
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3 - i; j++) {
                    const box = Bodies.rectangle(
                        width - 200 + (j * 40) - ((3-i)*20) + 20, 
                        height - 140 - (i * 40), 
                        38, 38, 
                        boxOptions
                    );
                    Composite.add(pyramid, box);
                }
            }

            Composite.add(world, [ground, platform, bird, sling, pyramid]);

            // 3. é¼ æ ‡/è§¦æ‘¸æ§åˆ¶
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, {
                mouse: mouse,
                constraint: {
                    stiffness: 0.2,
                    render: { visible: false }
                }
            });

            Composite.add(world, mouseConstraint);
            render.mouse = mouse;

            // 4. å‘å°„é€»è¾‘
            Events.on(engine, 'afterUpdate', function() {
                if (isFired) return;

                // å¦‚æœé¸Ÿè¢«æ‹‰è¿œå¹¶é‡Šæ”¾
                const dist = Math.hypot(bird.position.x - anchor.x, bird.position.y - anchor.y);
                
                // å‘å°„åˆ¤å®šï¼šé¼ æ ‡æ¾å¼€ä¸”é¸Ÿè·ç¦»é”šç‚¹æœ‰ä¸€å®šè·ç¦»
                if (mouse.button === -1 && dist > 20) {
                    // å»¶è¿Ÿä¸€ç‚¹æ–­å¼€ï¼Œè®©é¸Ÿè·å¾—åˆé€Ÿåº¦
                    setTimeout(() => {
                        bird = null; // æ ‡è®°ä¸ºå·²å‘å°„ï¼Œé˜²æ­¢å†æ¬¡æ‹–æ‹½
                        Composite.remove(world, sling);
                        isFired = true;
                    }, 20);
                }
            });

            // 5. ç¢°æ’/è®¡åˆ†é€»è¾‘ï¼ˆç®€å•ç‰ˆï¼‰
            Events.on(engine, 'collisionStart', function(event) {
                event.pairs.forEach((pair) => {
                    // ç®€å•çš„é€»è¾‘ï¼šå¦‚æœæ–¹å—æ’å‡»é€Ÿåº¦å¤Ÿå¿«ï¼Œå°±ç®—å¾—åˆ†
                    const bodyA = pair.bodyA;
                    const bodyB = pair.bodyB;
                    
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œåªè¦ç»¿è‰²æ–¹å—äº§ç”Ÿå‰§çƒˆç¢°æ’å°±ç®—åˆ†
                    if (bodyA.render.fillStyle === '#32CD32' || bodyB.render.fillStyle === '#32CD32') {
                        // æ£€æŸ¥é€Ÿåº¦
                        if (bodyA.speed > 5 || bodyB.speed > 5) {
                           updateScore(100);
                        }
                    }
                });
            });

            // å¯åŠ¨
            Render.run(render);
            runner = Runner.create();
            Runner.run(runner, engine);
        }

        function updateScore(points) {
            if (points === 0) score = 0;
            else score += points;
            document.getElementById('score').innerText = score;
        }

        // å¼€å§‹æ¸¸æˆ
        initGame();

        // çª—å£å¤§å°æ”¹å˜é€‚åº”
        window.addEventListener('resize', () => {
            initGame(); // ç®€å•ç²—æš´ï¼šé‡ç½®æ¸¸æˆä»¥é€‚åº”æ–°çª—å£
        });

    </script>
</body>
</html>